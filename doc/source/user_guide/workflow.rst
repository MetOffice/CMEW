.. (C) Crown Copyright 2022-2023, the Met Office.

.. include:: ../common.txt

The workflow
============

An overview of the workflow
---------------------------

|CMEW| performs the following steps:

``install_env_file``
  :Description:
     Activates the environment for |ESMValTool|, based on the ``SITE`` provided
  :Runs on:
     Localhost
  :Executes:
     The ``install_env_file.sh`` script from the |Rose| app
  :Details:
     Runs once at the start of the workflow

``configure_process``
  :Description:
     Creates and modifies the |ESMValTool| user configuration file
  :Runs on:
     Localhost
  :Executes:
     The ``configure_process.py`` script from the |Rose| app
  :Details:
     Runs once at the start of the workflow, immediately after the successful
     completion of the ``install_env_file`` job

``standardise_model_data``
  :Description:
     Launches the |CDDS| workflow and converts the data into a |CMIP| compliant
     format for |ESMValTool|
  :Runs on:
     Localhost
  :Executes:
     The ``cdds_convert`` command
  :Details:
     Runs after the successful completion of the ``configure_standardise`` job

``configure_standardise``
  :Description:
     Creates the ``request.json`` file and variables list which are needed to
     run |CDDS| and initiates the CDDS run directory.
  :Runs on:
     Localhost
  :Executes:
     The ``configure_standardise.sh`` script from the |Rose| app
  :Details:
     Runs once at the start of the workflow, immediately after the successful
     completion of the ``install_env_file`` job

``process``
  :Description:
     Runs the requested recipes using |ESMValTool|
  :Runs on:
     ``COMPUTE``, which depends on the ``SITE``; at the Met Office, the
     ``process`` jobs will run on SPICE
  :Executes:
     The |ESMValTool| command line script
  :Details:
     Runs after the successful completion of both the ``standardise_model_data`` job
     and the ``configure_process`` job. This job runs for every assessment area
     defined in the workflow

``compare``
  :Description:
     Ensures the expected output files are generated by the ``process`` jobs
  :Runs on:
     Localhost
  :Executes:
     The ``compare.sh`` script from the |Rose| app
  :Details:
     Runs for every assessment area defined in the workflow

Design considerations
---------------------

Portability
~~~~~~~~~~~

|CMEW| is portable; site-specific information can be found in the ``site`` and
``opt`` directories within the workflow. The files required are:

``site/<site>.cylc``
  Contains task definitions specific to the ``SITE``, for example, ``COMPUTE``

``site/<site>-standardise-env``
  Contains details on how to set up the environment for CDDS at the ``SITE``

``site/<site>-process-env``
  Contains details on how to set up the environment for ESMValTool at the
  ``SITE``

``opt/rose-suite-<site>.conf``
  Contains configuration items specific to the ``SITE``, including ``SITE``

Metadata
~~~~~~~~

|CMEW| uses Rose metadata. Every item defined in the suite configuration file
(``rose-suite.conf``) will have an entry in the main metadata configuration
file (``meta/rose-meta.conf``).

Resources
~~~~~~~~~

The resources used by the ``process`` jobs are defined in the
``site/<site>.cylc`` file, allowing the jobs to be configured by ``SITE`` as
well as by recipe. This ensures only the required resources are requested when
running each of the ``process`` jobs.
